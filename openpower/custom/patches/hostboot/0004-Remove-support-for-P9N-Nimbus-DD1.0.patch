From 9dea084810c6d55b88e2e64a82854ebb27db05ac Mon Sep 17 00:00:00 2001
From: Corey Swenson <cswenson@us.ibm.com>
Date: Tue, 30 Jan 2018 11:14:03 -0600
Subject: [PATCH 4/5] Remove support for P9N (Nimbus) DD1.0

- Will error out during IPL
- Gracefully handle removal of DD1.0 inits,
    tied to hw091517b.910 HCODE image

Change-Id: I8f14ba5669d811fde47c2630cfd71e3688710cca
---
 src/include/usr/isteps/istep_reasoncodes.H  |  4 +-
 src/usr/isteps/istep06/host_set_ipl_parms.C | 45 ++++++++++++++++++++-
 2 files changed, 47 insertions(+), 2 deletions(-)

diff --git a/src/include/usr/isteps/istep_reasoncodes.H b/src/include/usr/isteps/istep_reasoncodes.H
index 48139a517..ef455bb6c 100644
--- a/src/include/usr/isteps/istep_reasoncodes.H
+++ b/src/include/usr/isteps/istep_reasoncodes.H
@@ -5,7 +5,7 @@
 /*                                                                        */
 /* OpenPOWER HostBoot Project                                             */
 /*                                                                        */
-/* Contributors Listed Below - COPYRIGHT 2015,2017                        */
+/* Contributors Listed Below - COPYRIGHT 2015,2018                        */
 /* [+] International Business Machines Corp.                              */
 /*                                                                        */
 /*                                                                        */
@@ -61,6 +61,7 @@ namespace ISTEP
         MOD_HANDLE_SBE_REG_VALUE                          = 0x19,
         MOD_SBE_PERFORM_UPDATE_CHECK                      = 0x1A,
         MOD_SBE_GET_FFDC_HANDLER                          = 0x1C,
+        MOD_SET_IPL_PARMS                                 = 0x1D,
     };
 
     /**
@@ -121,6 +122,7 @@ namespace ISTEP
         RC_SBE_UPDATE_IN_MPIPL                   = ISTEP_COMP_ID | 0x32,
         RC_NO_FFDC_RETURNED                      = ISTEP_COMP_ID | 0x33,
         RC_RETURNED_FFDC                         = ISTEP_COMP_ID | 0x34,
+        RC_P9N_DD1_NOT_SUPPORTED                 = ISTEP_COMP_ID | 0x35,
     };
 
 };
diff --git a/src/usr/isteps/istep06/host_set_ipl_parms.C b/src/usr/isteps/istep06/host_set_ipl_parms.C
index 8fe9f12cc..cd2fe0f4c 100644
--- a/src/usr/isteps/istep06/host_set_ipl_parms.C
+++ b/src/usr/isteps/istep06/host_set_ipl_parms.C
@@ -5,7 +5,7 @@
 /*                                                                        */
 /* OpenPOWER HostBoot Project                                             */
 /*                                                                        */
-/* Contributors Listed Below - COPYRIGHT 2015,2017                        */
+/* Contributors Listed Below - COPYRIGHT 2015,2018                        */
 /* [+] International Business Machines Corp.                              */
 /*                                                                        */
 /*                                                                        */
@@ -31,6 +31,9 @@
 #include <initservice/isteps_trace.H>
 #include <util/utilsemipersist.H>
 #include <hwas/common/deconfigGard.H>
+#include <arch/pvrformat.H>
+#include <sys/mmio.h>
+#include <console/consoleif.H>
 
 
 namespace ISTEP_06
@@ -77,6 +80,46 @@ void* host_set_ipl_parms( void *io_pArgs )
     Util::writeSemiPersistData(l_semiData);
 
 
+    // Add a check to indicate that Nimbus DD1.0 is NOT supported
+    // and prevent a boot
+    PVR_t l_pvr( mmio_pvr_read() & 0xFFFFFFFF );
+    if( l_pvr.isNimbusDD1() )
+    {
+#ifdef CONFIG_CONSOLE
+        CONSOLE::displayf(ISTEP_COMP_NAME,
+                          "P9N (Nimbus) DD1.0 is not supported in this driver");
+        CONSOLE::displayf(ISTEP_COMP_NAME,
+                          "Please update the system's processor modules");
+#endif
+
+
+        TRACFCOMP( ISTEPS_TRACE::g_trac_isteps_trace,
+                   "DD1.0 is NOT SUPPORTED anymore. "
+                   "Please upgrade proc modules");
+        /*@
+         * @errortype
+         * @moduleid     ISTEP::MOD_SET_IPL_PARMS
+         * @reasoncode   ISTEP::RC_P9N_DD1_NOT_SUPPORTED
+         * @userdata1    PVR of master proc
+         * @devdesc      P9N (Nimbus) DD1.x is not supported
+         *               in this firmware driver.  Please update
+         *               your module or use a different driver
+         * @custdesc     A problem occurred during the IPL
+         *               of the system.
+         */
+        uint64_t l_dummy = 0x0;
+        l_err = new ERRORLOG::ErrlEntry(
+                                        ERRORLOG::ERRL_SEV_UNRECOVERABLE,
+                                        ISTEP::MOD_SET_IPL_PARMS,
+                                        ISTEP::RC_P9N_DD1_NOT_SUPPORTED,
+                                        l_pvr.word,
+                                        l_dummy);
+        // Create IStep error log and cross ref error that occurred
+        l_stepError.addErrorDetails( l_err );
+        errlCommit( l_err, ISTEP_COMP_ID );
+    }
+
+
     TRACFCOMP( ISTEPS_TRACE::g_trac_isteps_trace, "host_set_ipl_parms exit" );
 
     return l_stepError.getErrorHandle();
-- 
2.17.1.windows.2

